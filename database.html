<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter', sans-serif; background:#1a1a2e; color:#e5e7eb; min-height:100vh; position:relative; overflow-x:hidden; }
body::before { content:''; position:fixed; width:100%; height:100%; top:0; left:0; z-index:-1;
  background: radial-gradient(ellipse at 10% 20%, rgba(99, 102, 241, 0.2) 0%, transparent 40%),
             radial-gradient(ellipse at 90% 70%, rgba(168, 85, 247, 0.18) 0%, transparent 40%),
             radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.12) 0%, transparent 50%);
}
header { background: rgba(25,29,56,0.85); backdrop-filter: blur(20px); border-bottom:1px solid rgba(255,255,255,0.06);
  padding:24px 48px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1000; }
.logo { display:flex; align-items:center; gap:16px; }
.logo-icon { width:48px; height:48px; background:linear-gradient(135deg,#6366f1,#a855f7); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:0 8px 32px rgba(99,102,241,0.3); }
.logo-text h1 { font-size:24px; font-weight:700; letter-spacing:-0.5px; background:linear-gradient(135deg,#6366f1,#a855f7); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo-text p { font-size:13px; color:rgba(229,231,235,0.6); font-weight:400; margin-top:2px; }
.back-button, .download-button { background:linear-gradient(135deg,#10b981,#059669); border:none; color:white; padding:12px 24px; border-radius:12px; font-weight:600; cursor:pointer; font-size:14px; text-decoration:none; display:flex; align-items:center; gap:8px; }
.download-all { background:linear-gradient(135deg,#f97316,#ea580c); }
.container { max-width:1400px; margin:48px auto; padding:0 48px; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:24px; margin-bottom:32px; }
.stat-card { background:rgba(25,29,56,0.65); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); padding:28px; border-radius:16px; }
.stat-label { font-size:13px; font-weight:600; text-transform:uppercase; color:rgba(229,231,235,0.6); margin-bottom:8px; }
.stat-value { font-size:32px; font-weight:700; background:linear-gradient(135deg,#6366f1,#a855f7); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.day-navigator { display:flex; justify-content:center; align-items:center; gap:24px; background:rgba(25,29,56,0.65); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:20px 32px; margin-bottom:32px; }
.nav-button { background:linear-gradient(135deg,#6366f1,#8b5cf6); border:none; color:white; padding:12px 24px; border-radius:10px; font-weight:600; cursor:pointer; }
.nav-button:disabled { opacity:0.3; cursor:not-allowed; }
.current-day { font-size:18px; font-weight:700; color:#6366f1; min-width:180px; text-align:center; letter-spacing:-0.3px; }
.table-container { background:rgba(25,29,56,0.65); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden; }
table { width:100%; border-collapse:collapse; }
thead { background:rgba(99,102,241,0.1); border-bottom:2px solid rgba(99,102,241,0.3); }
th, td { padding:18px 24px; font-size:14px; color:rgba(229,231,235,0.9); text-align:left; }
.id-col { color:#6366f1; font-weight:700; font-size:13px; }
.coord-col { font-family:'Monaco',monospace; color:#fbbf24; font-weight:500; }
.alt-col { color:#10b981; font-weight:700; }
.time-col { color:rgba(229,231,235,0.6); font-size:13px; font-family:'Monaco',monospace; }
.loading, .no-data { text-align:center; padding:64px 32px; color:rgba(229,231,235,0.5); font-size:15px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üõ∞Ô∏è</div>
    <div class="logo-text">
      <h1>Database Viewer</h1>
      <p>ISS Position Records Archive</p>
    </div>
  </div>
  <div style="display:flex; gap:12px;">
    <button class="download-button" onclick="downloadCSV()">üíæ Download Day CSV</button>
    <button class="download-button download-all" onclick="downloadAllCSV()">üåê Download All Days Combined</button>
    <a href="/" class="back-button">‚Üê Back to Dashboard</a>
  </div>
</header>

<div class="container">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Records</div>
      <div class="stat-value" id="totalRecords">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Days</div>
      <div class="stat-value" id="totalDays">0</div>
    </div>
  </div>

  <div class="day-navigator">
    <button class="nav-button" id="prevDay" onclick="changeDay(-1)">‚Üê Previous</button>
    <div class="current-day" id="currentDay">Loading...</div>
    <button class="nav-button" id="nextDay" onclick="changeDay(1)">Next ‚Üí</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Latitude (¬∞)</th>
          <th>Longitude (¬∞)</th>
          <th>Altitude (km)</th>
          <th>Velocity (km/h)</th>
          <th>Timestamp (MYT)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="6" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let records = [];
let days = [];
let currentDayIndex = 0;
let userManuallyChangedDay = false;

// --- Fetch all data from backend ---
async function fetchAllData() {
  try {
    const res = await fetch('/api/all-records');
    const data = await res.json();
    records = data.records || [];

    // extract unique days
    days = Array.from(new Set(records.map(r => r.day))).sort((a,b)=>new Date(a)-new Date(b));

    if(days.length === 0){
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
      document.getElementById('currentDay').innerText = '‚Äî';
      document.getElementById('totalRecords').innerText = '0';
      document.getElementById('totalDays').innerText = '0';
      return;
    }

    if(!userManuallyChangedDay) currentDayIndex = days.length - 1; // default to latest day

    updateSummary();
    renderTable();
  } catch(err) {
    console.error(err);
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="no-data">Failed to load data</td></tr>';
  }
}

function updateSummary(){
  document.getElementById('totalRecords').innerText = records.length.toLocaleString();
  document.getElementById('totalDays').innerText = days.length;
}

function renderTable(){
  if(days.length === 0) return;

  // clamp index
  if(currentDayIndex < 0) currentDayIndex = 0;
  if(currentDayIndex >= days.length) currentDayIndex = days.length - 1;

  const day = days[currentDayIndex];
  document.getElementById('currentDay').innerText = `Day ${currentDayIndex + 1} (${day})`;

  const dayRecords = records.filter(r => r.day === day);
  const tbody = document.getElementById('tableBody');

  if(!dayRecords.length){
    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No records for this day</td></tr>';
    return;
  }

  tbody.innerHTML = dayRecords.map((r,i)=>`
    <tr>
      <td class="id-col">#${r.id || i+1}</td>
      <td class="coord-col">${(r.latitude ?? 0).toFixed(4)}</td>
      <td class="coord-col">${(r.longitude ?? 0).toFixed4()}</td>
      <td class="alt-col">${r.altitude ? r.altitude.toFixed(2) : 'N/A'}</td>
      <td>${r.velocity ? r.velocity.toFixed(2) : 'N/A'}</td>
      <td class="time-col">${r.ts_myt.replace(/^'+|'+$/g,'')}</td>
    </tr>
  `).join('');

  document.getElementById('prevDay').disabled = currentDayIndex <= 0;
  document.getElementById('nextDay').disabled = currentDayIndex >= days.length - 1;
}

function changeDay(direction){
  userManuallyChangedDay = true;
  currentDayIndex -= direction; // newest day is last in array
  renderTable();
}

function downloadCSV(){
  window.location.href = '/api/download';
}

// --- Start loop ---
fetchAllData();
setInterval(fetchAllData, 15000);
</script>


</body>
</html>
