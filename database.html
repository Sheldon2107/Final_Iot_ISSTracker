<script>
let records = [];
let currentDayIndex = 0;
let days = [];
let userManuallyChangedDay = false; // Track if user manually navigated

// Fetch all records from server
async function fetchAllData() {
    try {
        const res = await fetch('/api/all-records?per_page=5000'); // get all records
        const data = await res.json();
        const newRecords = data.records || [];

        if (newRecords.length === 0) {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" class="no-data">No data available</td></tr>';
            document.getElementById('currentDay').innerText = 'â€”';
            document.getElementById('totalRecords').innerText = '0';
            document.getElementById('totalDays').innerText = '0';
            records = [];
            days = [];
            return;
        }

        // Keep old latest day
        const oldLatestDay = days.length > 0 ? days[days.length - 1] : null;

        records = newRecords;

        // Extract unique days from all records
        const daySet = new Set();
        records.forEach(r => {
            const day = r.ts_myt.replace(/^'+|'+$/g, '').split(' ')[0];
            daySet.add(day);
            r.day = day;
        });
        days = Array.from(daySet).sort();

        // Auto-switch to latest day if new day appears and user hasn't manually navigated
        const latestDay = days[days.length - 1];
        if (latestDay !== oldLatestDay && !userManuallyChangedDay) {
            currentDayIndex = days.length - 1;
        }

        // Reset manual flag if already on latest day
        if (currentDayIndex === days.length - 1) {
            userManuallyChangedDay = false;
        }

        updateSummary();
        renderTable();
    } catch(err) {
        console.error('Failed to fetch data:', err);
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" class="no-data">Failed to load data</td></tr>';
    }
}

function updateSummary() {
    document.getElementById('totalRecords').innerText = records.length.toLocaleString();
    const uniqueDays = [...new Set(records.map(r => r.day))];
    document.getElementById('totalDays').innerText = uniqueDays.length;
}

function renderTable() {
    if(days.length === 0) return;

    const day = days[currentDayIndex];
    document.getElementById('currentDay').innerText = day;

    const dayRecords = records.filter(r => r.day === day);
    const tbody = document.getElementById('tableBody');

    if(dayRecords.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No records for this day</td></tr>';
        return;
    }

    tbody.innerHTML = dayRecords.map((r, i) => `
<tr>
<td class="id-col">#${i+1}</td>
<td class="coord-col">${r.latitude.toFixed(4)}</td>
<td class="coord-col">${r.longitude.toFixed(4)}</td>
<td class="alt-col">${r.altitude ? r.altitude.toFixed(2) : 'N/A'}</td>
<td class="time-col">${r.ts_myt.replace(/^'+|'+$/g, '')}</td>
</tr>
`).join('');

    document.getElementById('prevDay').disabled = currentDayIndex === 0;
    document.getElementById('nextDay').disabled = currentDayIndex === days.length - 1;
}

function changeDay(direction){
    userManuallyChangedDay = true;
    currentDayIndex += direction;
    if(currentDayIndex < 0) currentDayIndex = 0;
    if(currentDayIndex >= days.length) currentDayIndex = days.length - 1;
    renderTable();
}

function downloadCSV(){
    window.location.href = '/api/download';
}

// Initial fetch
fetchAllData();

// Auto-refresh every 15 seconds for testing
setInterval(fetchAllData, 15000);
</script>
