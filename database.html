<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;position:relative;}
body::before{content:'';position:fixed;width:200%;height:200%;top:-50%;left:-50%;z-index:-1;background: radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3), transparent 50%), radial-gradient(circle at 80% 80%, rgba(33,150,243,0.3), transparent 50%); animation: drift 20s ease-in-out infinite;}
@keyframes drift{0%,100%{transform:translate(0,0);}50%{transform:translate(30px,-30px);}}

header{background: rgba(10,14,39,0.8);backdrop-filter: blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 40px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.title{font-size:28px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.header-buttons{display:flex;gap:10px;}
.back-btn{background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;text-decoration:none;display:inline-block;}
.back-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4);}

.container{max-width:1400px;margin:0 auto;padding:20px;}
.stats{display:flex;gap:20px;margin-bottom:20px;}
.stat-box{background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));border:1px solid rgba(102,126,234,0.2);border-radius:16px;padding:20px;text-align:center;}
.stat-label{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.6);margin-bottom:10px;}
.stat-value{font-size:28px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.controls{display:flex;gap:10px;align-items:center;margin-bottom:20px;}
.controls button{background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s;}
.controls button:hover{background:rgba(102,126,234,0.3);transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.3);}

.table-container{background: rgba(10,14,39,0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;}
thead{background:linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));position:sticky;top:0;z-index:10;}
th{padding:12px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.8);text-align:left;border-bottom:2px solid rgba(102,126,234,0.3);}
td{padding:10px;font-size:13px;color:rgba(232,234,246,0.8);border-bottom:1px solid rgba(255,255,255,0.05);font-weight:500;}
tbody tr:hover{background: rgba(102,126,234,0.08);}
.day-badge{background: rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);padding:4px 10px;border-radius:8px;font-weight:600;color:#10b981;display:inline-block;font-size:11px;}

.loading{text-align:center;padding:40px;font-size:16px;color:rgba(232,234,246,0.6);}
</style>
</head>
<body>
<header>
  <h1 class="title">üìä ISS Database Viewer</h1>
  <div class="header-buttons">
    <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
    <button class="back-btn" onclick="downloadCSV(true)">üìÇ Download All CSV</button>
  </div>
</header>

<div class="container">
  <div class="stats">
    <div class="stat-box">
      <div class="stat-label">Total Records</div>
      <div class="stat-value" id="totalRecords">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Current Day</div>
      <div class="stat-value" id="currentDay">--</div>
    </div>
  </div>

  <div class="controls">
    <button onclick="changeDay(-1)">‚¨Ö Day Back</button>
    <span id="dayInfo">Day -- of 3</span>
    <button onclick="changeDay(1)">‚û° Day Forward</button>
    <button onclick="downloadCSV(false)">üìÖ Download CSV for This Day</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp (UTC)</th>
          <th>Day</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Altitude (km)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="6" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let availableDays = [];
let currentDayIndex = 0;
let recordsPerDay = 1000;

async function fetchData(day=''){
  try {
    const params = new URLSearchParams({ per_page: recordsPerDay });
    if(day) params.append('day', day);
    const res = await fetch(`/api/all-records?${params.toString()}`);
    const data = await res.json();

    availableDays = data.available_days.sort(); // ensure ascending
    if(day && availableDays.includes(day)){
      currentDayIndex = availableDays.indexOf(day);
    } else if(currentDayIndex >= availableDays.length){
      currentDayIndex = availableDays.length - 1;
    }

    updateTable();
  } catch(err){
    console.error(err);
    document.getElementById('tableBody').innerHTML='<tr><td colspan="6" class="loading" style="color:#ef4444;">Error loading data</td></tr>';
  }
}

function updateTable(){
  const day = availableDays[currentDayIndex];
  document.getElementById('currentDay').textContent = day || '--';
  document.getElementById('dayInfo').textContent = day ? `Day ${currentDayIndex+1} of ${availableDays.length}` : 'Day -- of 3';

  if(!day){
    document.getElementById('tableBody').innerHTML='<tr><td colspan="6" class="loading">No records yet</td></tr>';
    return;
  }

  fetch(`/api/all-records?day=${day}&per_page=${recordsPerDay}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      if(data.records.length === 0){
        tbody.innerHTML='<tr><td colspan="6" class="loading">No records for this day</td></tr>';
        return;
      }
      data.records.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>#${r.id}</td>
          <td>${r.timestamp}</td>
          <td><span class="day-badge">${r.day}</span></td>
          <td>${Number(r.latitude).toFixed(4)}</td>
          <td>${Number(r.longitude).toFixed(4)}</td>
          <td>${r.altitude !== null ? Number(r.altitude).toFixed(2) : '‚Äî'}</td>
        `;
        tbody.appendChild(tr);
      });
    });
}

function changeDay(offset){
  if(!availableDays.length) return;
  currentDayIndex += offset;
  if(currentDayIndex < 0) currentDayIndex = 0;
  if(currentDayIndex >= availableDays.length) currentDayIndex = availableDays.length - 1;
  updateTable();
}

function downloadCSV(all=false){
  let url = '/api/download-csv';
  if(all) url += '?all=1';
  else if(availableDays[currentDayIndex]) url += '?day=' + availableDays[currentDayIndex];
  window.open(url, '_blank');
}

// Initial load
fetchData();
</script>
</body>
</html>
