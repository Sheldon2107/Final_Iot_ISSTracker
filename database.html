<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;position:relative;}
body::before {content:'';position:fixed;width:200%;height:200%;top:-50%;left:-50%;z-index:-1;background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%), radial-gradient(circle at 80% 80%, rgba(33, 150, 243, 0.3), transparent 50%), radial-gradient(circle at 40% 20%, rgba(156, 39, 176, 0.2), transparent 50%); animation: drift 20s ease-in-out infinite;}
@keyframes drift {0%,100%{transform:translate(0,0) rotate(0deg);}33%{transform:translate(30px,-30px) rotate(5deg);}66%{transform:translate(-20px,20px) rotate(-5deg);}}

header {background: rgba(10, 14, 39, 0.8);backdrop-filter: blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 40px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;}
.logo {display:flex;align-items:center;gap:12px;}
.logo-icon {width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 20px rgba(102,126,234,0.4);}
.logo-text h1 {font-size:22px;font-weight:700;letter-spacing:-0.5px;}
.logo-text p {font-size:12px;color:rgba(232,234,246,0.5);font-weight:400;}
.back-button {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.3s;text-decoration:none;display:flex;align-items:center;gap:8px;}
.back-button:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4);}

.container {max-width:1400px;margin:40px auto;padding:0 40px;}

.stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:40px;}
.stat-card {background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));border:1px solid rgba(102,126,234,0.2);border-radius:16px;padding:24px;transition:all 0.3s;}
.stat-card:hover {transform:translateY(-4px);border-color:rgba(102,126,234,0.5);box-shadow:0 12px 40px rgba(102,126,234,0.2);}
.stat-label {font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.6);margin-bottom:10px;}
.stat-value {font-size:36px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.stat-unit {font-size:18px;color: rgba(232,234,246,0.4);font-weight:500;margin-left:4px;}

.download-section {background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));border:1px solid rgba(16,185,129,0.3);border-radius:16px;padding:30px;margin-bottom:40px;}
.download-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.download-title {font-size:20px;font-weight:700;color:#10b981;}
.download-info {font-size:14px;color:rgba(232,234,246,0.7);margin-bottom:20px;line-height:1.6;}
.download-button {background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;padding:16px 32px;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;transition:all 0.3s;display:inline-flex;align-items:center;gap:12px;}
.download-button:hover {transform:translateY(-2px);box-shadow:0 8px 30px rgba(16,185,129,0.4);}
.download-button:active {transform:translateY(0);}

.preview-section {background: rgba(10,14,39,0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;}
.preview-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.preview-title {font-size:20px;font-weight:700;}
.day-navigator {display:flex;align-items:center;gap:15px;background: rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.3);border-radius:12px;padding:12px 20px;}
.nav-button {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;display:flex;align-items:center;gap:6px;}
.nav-button:hover {transform:translateY(-2px);box-shadow:0 4px 15px rgba(102,126,234,0.4);}
.nav-button:disabled {opacity:0.3;cursor:not-allowed;transform:none;}
.current-day {font-size:16px;font-weight:600;color:#667eea;min-width:150px;text-align:center;}
.record-count {font-size:13px;color:rgba(232,234,246,0.6);font-weight:500;}

.table-container {overflow-x:auto;margin-top:20px;}
table {width:100%;border-collapse:collapse;}
thead {background: rgba(102,126,234,0.2);border-bottom:2px solid rgba(102,126,234,0.5);}
th {padding:16px;text-align:left;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.8);}
tbody tr {border-bottom:1px solid rgba(255,255,255,0.05);transition:all 0.2s;}
tbody tr:hover {background: rgba(102,126,234,0.1);}
td {padding:14px 16px;font-size:13px;color:rgba(232,234,246,0.9);}
.id-col {color:#667eea;font-weight:600;}
.coord-col {font-family:monospace;color:#f59e0b;}
.alt-col {color:#10b981;font-weight:600;}
.time-col {color:rgba(232,234,246,0.7);font-size:12px;}

.loading {text-align:center;padding:40px;color:rgba(232,234,246,0.6);font-size:14px;}
.no-data {text-align:center;padding:60px;color:rgba(232,234,246,0.5);font-size:16px;}

.pagination {display:flex;justify-content:center;align-items:center;gap:15px;margin-top:30px;padding:20px;}
.page-button {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;}
.page-button:hover {transform:translateY(-2px);box-shadow:0 4px 15px rgba(102,126,234,0.4);}
.page-button:disabled {opacity:0.3;cursor:not-allowed;transform:none;}
.page-info {font-size:14px;color:rgba(232,234,246,0.7);font-weight:500;}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon">üìä</div>
    <div class="logo-text"><h1>Database Viewer</h1><p>ISS Position Records Archive</p></div>
  </div>
  <a href="/" class="back-button">
    <span>‚Üê</span>
    <span>Back to Dashboard</span>
  </a>
</header>

<div class="container">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Records</div>
      <div class="stat-value"><span id="totalRecords">--</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Days</div>
      <div class="stat-value"><span id="totalDays">--</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Data Range</div>
      <div class="stat-value" style="font-size:16px;"><span id="dateRange">Loading...</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Collection Rate</div>
      <div class="stat-value"><span id="collectionRate">--</span><span class="stat-unit">sec</span></div>
    </div>
  </div>

  <div class="download-section">
    <div class="download-header">
      <div class="download-title">üì• Export Complete Database</div>
    </div>
    <div class="download-info">
      Download all ISS position records spanning <strong id="spanDays">--</strong> days as a CSV file. 
      The file includes: ID, Latitude, Longitude, Altitude, Timestamp, Day, and Created At for every recorded position.
    </div>
    <button class="download-button" onclick="downloadCSV()">
      <span style="font-size:24px;">üíæ</span>
      <span>Download All Data (CSV)</span>
    </button>
  </div>

  <div class="preview-section">
    <div class="preview-header">
      <div class="preview-title">üìã Data Preview</div>
      <div class="day-navigator">
        <button class="nav-button" id="prevDay" onclick="changeDay(-1)">
          <span>‚Üê</span>
          <span>Previous</span>
        </button>
        <div>
          <div class="current-day" id="currentDay">Loading...</div>
          <div class="record-count" id="dayRecordCount">-- records</div>
        </div>
        <button class="nav-button" id="nextDay" onclick="changeDay(1)">
          <span>Next</span>
          <span>‚Üí</span>
        </button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Latitude (¬∞)</th>
            <th>Longitude (¬∞)</th>
            <th>Altitude (km)</th>
            <th>Timestamp (UTC)</th>
            <th>Day</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6" class="loading">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let availableDays = [];
let currentDayIndex = 0;
let currentPage = 1;
let totalPages = 1;
let recordsPerPage = 500;
let stats = {};

async function loadStats(){
  try {
    const res = await fetch('/api/stats');
    stats = await res.json();
    
    document.getElementById('totalRecords').innerText = stats.total_records.toLocaleString();
    document.getElementById('totalDays').innerText = Object.keys(stats.records_per_day).length;
    document.getElementById('collectionRate').innerText = stats.collection_interval_seconds;
    
    if(stats.first_record && stats.last_record){
      const first = stats.first_record.split(' ')[0];
      const last = stats.last_record.split(' ')[0];
      document.getElementById('dateRange').innerText = `${first} to ${last}`;
    }
    
    document.getElementById('spanDays').innerText = Object.keys(stats.records_per_day).length;
  } catch(err){
    console.error('Failed to load stats:', err);
  }
}

async function loadDayData(){
  if(!availableDays.length) return;
  
  const selectedDay = availableDays[currentDayIndex];
  document.getElementById('currentDay').innerText = selectedDay;
  
  try {
    const res = await fetch(`/api/all-records?day=${selectedDay}&page=${currentPage}&per_page=${recordsPerPage}`);
    const data = await res.json();
    
    availableDays = data.available_days;
    totalPages = data.total_pages;
    
    document.getElementById('dayRecordCount').innerText = `${data.total.toLocaleString()} records`;
    document.getElementById('currentPage').innerText = currentPage;
    document.getElementById('totalPages').innerText = totalPages;
    
    // Update navigation buttons
    document.getElementById('prevDay').disabled = currentDayIndex >= availableDays.length - 1;
    document.getElementById('nextDay').disabled = currentDayIndex <= 0;
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
    
    // Render table
    const tbody = document.getElementById('tableBody');
    if(data.records.length === 0){
      tbody.innerHTML = '<tr><td colspan="6" class="no-data">No records found for this day</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.records.map(r => `
      <tr>
        <td class="id-col">#${r.id}</td>
        <td class="coord-col">${r.latitude.toFixed(4)}</td>
        <td class="coord-col">${r.longitude.toFixed(4)}</td>
        <td class="alt-col">${r.altitude ? r.altitude.toFixed(2) : 'N/A'}</td>
        <td class="time-col">${r.ts_utc}</td>
        <td>${r.day}</td>
      </tr>
    `).join('');
    
  } catch(err){
    console.error('Failed to load day data:', err);
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="no-data">Failed to load data</td></tr>';
  }
}

async function initializeViewer(){
  await loadStats();
  
  try {
    const res = await fetch('/api/all-records?page=1&per_page=1');
    const data = await res.json();
    availableDays = data.available_days;
    currentDayIndex = 0;
    await loadDayData();
  } catch(err){
    console.error('Failed to initialize:', err);
  }
}

function changeDay(direction){
  currentDayIndex += direction;
  if(currentDayIndex < 0) currentDayIndex = 0;
  if(currentDayIndex >= availableDays.length) currentDayIndex = availableDays.length - 1;
  currentPage = 1;
  loadDayData();
}

function changePage(direction){
  currentPage += direction;
  if(currentPage < 1) currentPage = 1;
  if(currentPage > totalPages) currentPage = totalPages;
  loadDayData();
}

function downloadCSV(){
  window.location.href = '/api/download';
}

initializeViewer();
</script>
</body>
</html>
